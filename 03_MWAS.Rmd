---
title: "03_MWAS"
author: "Puvvula"
date: "2023-03-03"
output: pdf_document
---

```{r}
library(pacman)
pacman::p_load(tidyverse, janitor)
path <- "~/Documents/MWAS_home/pj_dat/"
```

#===============================================================================

## Select either mom or baby data from below

#MOM analysis
```{r}
covariates<- read_csv(paste0(path, "pah_fin_impu.csv"))  |>
  select(c(2:11,17,20,23,25,26)) |>
  rename(subject_id = "participant_id_mom",
         `1-Hydroxynapthalene` = "nap1",
         `2-Hydroxynapthalene` = "nap2",
         `2-Hydroxyfluorene` = "fluo2",
         `1-Hydroxyphenanthrene` = "phen1",
         `2,3-Hydroxyphenanthrene` = "phen23",
         `4-Hydroxyphenanthrene` = "phen4",
         `9-Hydroxyphenanthrene` = "phen9",
         `1-Hydroxypyrene` = "pyr1",
         `sigma-LMWT-PAH` = "sigma_lmwt_pah") |>
  mutate(across(where(is.character), factor))
```

#BABY analysis
```{r}
covariates<- read_csv(paste0(path, "pah_fin_impu.csv"))  |>
  select(c(2:11,18,20,21,23:26)) |>
  rename(subject_id = "participant_id_baby",
         `1-Hydroxynapthalene` = "nap1",
         `2-Hydroxynapthalene` = "nap2",
         `2-Hydroxyfluorene` = "fluo2",
         `1-Hydroxyphenanthrene` = "phen1",
         `2,3-Hydroxyphenanthrene` = "phen23",
         `4-Hydroxyphenanthrene` = "phen4",
         `9-Hydroxyphenanthrene` = "phen9",
         `1-Hydroxypyrene` = "pyr1",
         `sigma-LMWT-PAH` = "sigma_lmwt_pah") |>
  mutate(across(where(is.character), factor)) |>
  drop_na()
```

#===============================================================================
#===============================================================================
## Select only one dataset from this section

#mz and retention time - MOM - C18 Negative
```{r}
feature_table <- read_csv("~/Documents/MWAS_home/pj_dat/lc_ms_c18neg_mom.csv") |>
  select(-c(3:10))|>
  mutate(across(3:last_col(), ~ log10(. + 1))) |>
  mutate(across(3:last_col(), ~ (. - mean(.)) / sd(.)))
```

#mz and retention time - MOM - hilic positive
```{r}
feature_table <- read_csv("~/Documents/MWAS_home/pj_dat/lc_ms_hilicpos_mom.csv") |>
  select(-c(3:10))|>
  mutate(across(3:last_col(), ~ log10(. + 1))) |>
  mutate(across(3:last_col(), ~ (. - mean(.)) / sd(.)))
```

#mz and retention time - BABY - C18 Negative
```{r}
feature_table <- read_csv("~/Documents/MWAS_home/pj_dat/lc_ms_c18neg_baby.csv") |>
  select(-c(3:10))|>
  mutate(across(3:last_col(), ~ log10(. + 1))) |>
  mutate(across(3:last_col(), ~ (. - mean(.)) / sd(.)))
```

#mz and retention time - BABY - hilic positive
```{r}
feature_table <- read_csv("~/Documents/MWAS_home/pj_dat/lc_ms_hilicpos_baby.csv") |>
  select(-c(3:10))|>
  mutate(across(3:last_col(), ~ log10(. + 1))) |>
  mutate(across(3:last_col(), ~ (. - mean(.)) / sd(.)))
```


#===============================================================================

#align subject_id with the order from mz feature table
```{r shuffle FT columns}
matches <- c(1:2, match(covariates$subject_id, names(feature_table))) 
feature_table <- feature_table[matches]
```

#check order
```{r}
match(names(feature_table)[-c(1:2)], covariates$subject_id)
```

#revised MWAS loop
#covariates for mom: mom_ppbmi + mom_age + pgtob + mom_edu_cat + race_cat
#covariates for baby: mom_ppbmi + mom_age + pgtob + mom_edu_cat + race_cat + totpg + sex
```{r}
result_list <- list() # create empty list to store results
variables <- names(covariates[1:9]) # list of variables to analyze

for (variable in variables) {
  current_results <- data.frame(matrix(nrow = nrow(feature_table), ncol = 4)) # create a new data frame for each variable
  names(current_results) <- c("Estimate", "Std. Error", "t value", "Pr(>|t|)")
  for (i in 1:nrow(feature_table)){
    metabolite <- unlist(feature_table[i,-c(1:2)]) # store the ith metabolite in new vector
    current_results[i,] <- summary(lm(metabolite ~ get(variable) + mom_ppbmi + mom_age + pgtob + mom_edu_cat + race_cat + totpg + sex,
                             data=covariates))$coefficients[2,c(1:4)] # store regression results for ith metabolite
  }
  current_results$FDR <- p.adjust(current_results[[4]], method=c("fdr")) # fdr adjustment
  current_results <- cbind(feature_table[c(1:2)], current_results) # add mz and time
  current_results$Variable <- variable
  result_list[[variable]] <- current_results # add current results to list
}

PAH_MWAS_result <- do.call(rbind, result_list) # combine all results into one data frame
```

#summary of significant features and estimating  FDR cutoff
```{r}
result_summary<- PAH_MWAS_result |>
  rename(p_value = 6) |>
  group_by(Variable) |> 
  summarize(count = n(), sign_features = sum(p_value < 0.2)) |>
  mutate(fdr_cutoff = ((sign_features-1)/(count-1))*0.2 ) |>
  mutate(run = "c18neg", mom_baby = "mom")

fdr_threshold<- result_summary %>% select(run, mom_baby, Variable, fdr_cutoff)
write_csv(fdr_threshold, "~/Documents/MWAS_home/pj_results/pah_baby/hilic_pos/hilic_pos_baby_threshold.csv")
```

#add significance and beta direction
```{r}
PAH_MWAS_result <- PAH_MWAS_result |>
  rename(p_value = 6) |>
  left_join(fdr_threshold, by = "Variable") |>
  mutate(beta_dir = case_when(
    p_value < fdr_cutoff & Estimate > 0 ~ "positive-significant",
    p_value < fdr_cutoff & Estimate < 0 ~ "negative-significant",
    p_value > fdr_cutoff & Estimate > 0 ~ "positive-non_significant",
    p_value > fdr_cutoff & Estimate < 0 ~ "negative-non_significant"))

write_csv(PAH_MWAS_result, "~/Documents/MWAS_home/pj_results/pah_baby/hilic_pos/hilic_pos_baby_MWAS.csv")
```


Manhattan plot
```{r}
ggplot(PAH_MWAS_result, aes(x=mz, y=-log10(p_value), color=beta_dir)) +
  geom_point(size=0.5) +
  scale_x_continuous(name="Mass-to-charge ratio ", labels=scales::comma) +
  scale_y_continuous(name="-log10(P-value)", labels=scales::comma) +
  facet_wrap(~ factor(Variable, levels=c("1-Hydroxynapthalene", "2-Hydroxynapthalene", "2-Hydroxyfluorene",
                                 "1-Hydroxyphenanthrene", "2,3-Hydroxyphenanthrene", "4-Hydroxyphenanthrene",
                                 "9-Hydroxyphenanthrene", "sigma-LMWT-PAH", "1-Hydroxypyrene")),
             ncol=3, nrow=3, scales="free_y") +
  theme_bw() +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.position="bottom", # set legend position to bottom
        legend.box="horizontal") + 
  labs(color="Beta direction")+
  scale_color_manual(values = c("positive-significant" = "blue",
                                "negative-significant" = "red",
                                "positive-non_significant" = "grey",
                                "negative-non_significant" = "grey"))

ggsave("~/Documents/MWAS_home/pj_results/pah_baby/hilic_pos/hilic_pos_baby.tiff",
       dpi=300, height = 8, width = 8)
```


